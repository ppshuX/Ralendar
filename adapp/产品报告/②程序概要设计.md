# ② 程序概要设计

## 2.1 系统架构

本应用采用 **分层架构** 设计，主要分为以下层次：

### 2.1.1 UI层（Presentation Layer）

**职责**：用户界面展示和交互

**主要组件**：
- **Activity**：
  - `MainActivity`：主界面，包含日历视图、日程列表、节日信息等
  - `SubscriptionsActivity`：订阅管理界面，管理公共日历和节日订阅
  - `FestivalDetailActivity`：节日详情界面，显示节日介绍和AI问答
  - `MapPickerActivity`：地图选择界面，用于选择日程地点
  - `LoginActivity`：登录界面，支持云端模式登录
  - `SettingsActivity`：设置界面，管理应用设置

- **Adapter**：
  - `EventAdapter`：日程列表适配器，显示日程列表
  - `TimeSlotAdapter`：时间线适配器，用于周视图和日视图
  - `SubscriptionAdapter`：订阅列表适配器，显示订阅的日历
  - `FestivalSubscriptionAdapter`：节日订阅适配器，管理节日订阅
  - `LocationSearchAdapter`：地点搜索适配器，显示搜索结果

- **Dialog Helper**：
  - `EventEditDialogHelper`：可复用的日程编辑对话框组件

**设计模式**：
- **MVC/MVP模式**：Activity作为Controller，Adapter处理View，Manager处理业务逻辑
- **适配器模式**：使用Adapter模式处理列表数据

---

### 2.1.2 业务逻辑层（Business Logic Layer）

**职责**：业务逻辑处理和数据处理

**主要组件**：
- **Manager**：
  - `ReminderManager`：提醒管理器，负责设置和取消系统闹钟提醒
  - `SubscriptionManager`：订阅管理器，处理公共日历订阅
  - `FestivalSubscriptionManager`：节日订阅管理器，管理节日订阅状态
  - `HolidayManager`：节日信息管理器，加载和显示节日信息
  - `WeatherManager`：天气管理器，获取和显示天气信息
  - `FortuneManager`：运势管理器，生成和显示每日运势
  - `AIAssistant`：AI助手，处理自然语言解析和AI问答

- **Repository**：
  - `EventRepository`：统一的数据访问层，支持本地/云端数据访问

**设计模式**：
- **Manager模式**：每个Manager负责特定功能的业务逻辑
- **Repository模式**：统一的数据访问接口，隐藏数据来源细节
- **Facade模式**：CalendarApi统一所有API接口

---

### 2.1.3 数据层（Data Layer）

**职责**：数据持久化和数据访问

**主要组件**：
- **Database**（Room）：
  - `AppDatabase`：数据库实例，管理所有数据库表
  - `EventDao`：日程数据访问对象，提供日程的增删改查操作
  - `SubscriptionDao`：订阅数据访问对象，提供订阅的增删改查操作

- **Models**：
  - `Event`：日程数据模型
  - `Subscription`：订阅数据模型

- **Preferences**（SharedPreferences）：
  - `FestivalSubscriptionManager`：使用SharedPreferences存储节日订阅状态
  - `PreferenceManager`：使用SharedPreferences存储应用配置

- **Network**（Retrofit）：
  - `RetrofitClient`：Retrofit单例客户端，统一网络请求配置
  - `CalendarApi`：统一API接口，聚合所有服务接口
  - **Service接口**：
    - `EventService`：日程相关API
    - `HolidayService`：节日相关API
    - `CalendarService`：日历相关API（农历、订阅等）
    - `AIService`：AI助手相关API
    - `WeatherService`：天气相关API
    - `AuthService`：认证相关API

**设计模式**：
- **DAO模式**：使用Room的DAO模式提供数据访问
- **单例模式**：RetrofitClient使用单例模式
- **Facade模式**：CalendarApi统一所有API接口

---

## 2.2 核心模块设计

### 2.2.1 日历视图模块

#### 月视图
- **组件**：`CalendarView`（使用 kizitonwose/calendar 库）
- **功能**：
  - 显示整月日历网格
  - 日期选择
  - 日程标记
  - 节日显示
- **数据绑定**：`MonthDayBinder` 绑定日期数据到视图

#### 周视图
- **组件**：`WeekCalendarView`（使用 kizitonwose/calendar 库）
- **功能**：
  - 横向7天日期选择器
  - 时间线视图（24小时）
  - 按时间段显示日程
- **数据绑定**：`WeekDayBinder` 绑定日期数据到视图

#### 日视图
- **组件**：`RecyclerView` + `TimeSlotAdapter`
- **功能**：
  - 单日详细时间线
  - 按时间段显示日程
  - 精确到小时级别

---

### 2.2.2 日程管理模块

#### 数据模型
- **Event**：日程数据模型
  - `id`：日程ID
  - `title`：标题
  - `description`：描述
  - `dateTime`：日期时间（Unix时间戳）
  - `reminderMinutes`：提醒提前分钟数
  - `locationName`：地点名称
  - `latitude`：纬度
  - `longitude`：经度
  - `subscriptionId`：订阅ID（如果是订阅的日程）

#### 数据访问
- **EventDao**：Room DAO接口
  - `insert(event)`：插入日程
  - `update(event)`：更新日程
  - `delete(event)`：删除日程
  - `getUserEvents()`：获取用户创建的日程
  - `getAllEvents()`：获取所有日程（包括订阅的）

#### 数据同步
- **EventRepository**：统一的数据访问层
  - `getAllEvents()`：获取所有日程（本地/云端）
  - `addEvent(event)`：添加日程（本地/云端）
  - `updateEvent(event)`：更新日程（本地/云端）
  - `deleteEvent(event)`：删除日程（本地/云端）

---

### 2.2.3 提醒模块

#### ReminderManager
- **职责**：管理日程提醒
- **功能**：
  - `setReminder(event)`：设置提醒
  - `cancelReminder(event)`：取消提醒
  - `updateReminder(event)`：更新提醒

#### AlarmReceiver
- **职责**：处理提醒通知
- **功能**：
  - 接收系统闹钟广播
  - 显示系统通知
  - 点击通知跳转到日程详情

#### 实现原理
```kotlin
// 设置提醒
val reminderTime = event.dateTime - (event.reminderMinutes * 60 * 1000)
val intent = Intent(context, AlarmReceiver::class.java)
val pendingIntent = PendingIntent.getBroadcast(...)
alarmManager.setExact(AlarmManager.RTC_WAKEUP, reminderTime, pendingIntent)
```

---

### 2.2.4 订阅模块

#### SubscriptionManager
- **职责**：管理公共日历订阅
- **功能**：
  - `subscribeCalendar(slug, name)`：订阅公共日历
  - `unsubscribeCalendar(subscription)`：取消订阅
  - `getVisibleEvents(date)`：获取可见的订阅事件

#### FestivalSubscriptionManager
- **职责**：管理节日订阅
- **功能**：
  - `subscribe(festivalName)`：订阅节日
  - `unsubscribe(festivalName)`：取消订阅
  - `isSubscribed(festivalName)`：检查是否已订阅
  - `initDefaultFestivals()`：初始化默认节日订阅

#### 数据存储
- **Subscription**：订阅数据模型（存储在Room数据库）
- **FestivalSubscription**：节日订阅状态（存储在SharedPreferences）

---

### 2.2.5 网络模块

#### RetrofitClient
- **职责**：统一网络请求配置
- **配置**：
  - Base URL：`https://app7626.acapp.acwing.com.cn/api/`
  - 超时设置：30秒
  - 日志拦截器：开发环境开启
  - 转换器：Gson

#### CalendarApi
- **职责**：统一API接口（Facade模式）
- **继承**：所有Service接口
- **使用**：`RetrofitClient.api.xxx()`

#### Service接口
- **EventService**：日程相关API
- **HolidayService**：节日相关API
- **CalendarService**：日历相关API
- **AIService**：AI助手相关API
- **WeatherService**：天气相关API
- **AuthService**：认证相关API

---

## 2.3 数据流设计

### 2.3.1 日程数据流

```
用户操作（添加/编辑/删除日程）
    ↓
UI层（MainActivity）
    ↓
Repository（EventRepository）
    ↓
判断模式（本地/云端）
    ├─ 本地模式 → EventDao → Room数据库
    └─ 云端模式 → CalendarApi → 后端API
    ↓
数据更新
    ↓
UI刷新（更新列表、更新日历标记）
```

### 2.3.2 订阅数据流

```
用户订阅请求
    ↓
UI层（SubscriptionsActivity）
    ↓
SubscriptionManager
    ↓
调用API获取日历事件
    ↓
解析事件数据
    ↓
保存到数据库（EventDao + SubscriptionDao）
    ↓
更新日历显示（datesWithFestivals）
```

### 2.3.3 提醒数据流

```
日程创建/更新
    ↓
ReminderManager.setReminder()
    ↓
计算提醒时间
    ↓
AlarmManager.setExact()
    ↓
系统设置闹钟
    ↓
到达提醒时间
    ↓
AlarmReceiver接收广播
    ↓
显示系统通知
    ↓
用户点击通知
    ↓
跳转到日程详情
```

### 2.3.4 节日数据流

```
加载节日信息
    ↓
HolidayManager.loadHolidayInfo()
    ↓
调用API获取节日信息
    ↓
检查订阅状态（FestivalSubscriptionManager）
    ↓
过滤已订阅的节日
    ↓
创建节日卡片
    ↓
更新日历标记（datesWithFestivals）
```

---

## 2.4 关键技术选型

### 开发语言
- **Kotlin**：现代化的JVM语言，与Java完全兼容，语法简洁

### UI框架
- **Material Design 3**：Google最新的设计规范
- **AndroidX**：最新的Android支持库

### 数据库
- **Room**：Google推荐的SQLite封装库
  - 类型安全的SQL查询
  - 编译时检查
  - 支持Kotlin Coroutines

### 网络框架
- **Retrofit 2**：类型安全的HTTP客户端
  - 支持Kotlin Coroutines
  - 自动JSON序列化/反序列化
  - 易于扩展

### 异步处理
- **Kotlin Coroutines**：轻量级并发框架
  - 非阻塞异步操作
  - 简洁的代码
  - 统一的异常处理

### 架构模式
- **MVVM/MVP**：分层架构模式
- **Repository模式**：统一数据访问
- **Manager模式**：业务逻辑封装

### 第三方库
- **kizitonwose/calendar**：日历视图组件
- **百度地图SDK**：地图功能
- **Material Components**：Material Design组件

---

## 2.5 项目结构

```
adapp/app/src/main/java/com/ncu/kotlincalendar/
├── api/                           # 网络层
│   ├── CalendarApi.kt             # 统一API接口
│   ├── client/
│   │   └── RetrofitClient.kt      # Retrofit客户端
│   ├── models/                    # 数据模型
│   │   ├── EventModels.kt
│   │   ├── HolidayModels.kt
│   │   └── AIModels.kt
│   └── services/                  # 服务接口
│       ├── EventService.kt
│       ├── HolidayService.kt
│       └── AIService.kt
│
├── data/                          # 数据层
│   ├── database/                  # Room数据库
│   │   ├── AppDatabase.kt
│   │   ├── EventDao.kt
│   │   └── SubscriptionDao.kt
│   ├── models/                    # 数据实体
│   │   ├── Event.kt
│   │   └── Subscription.kt
│   ├── managers/                  # 业务逻辑管理器
│   │   ├── ReminderManager.kt
│   │   ├── SubscriptionManager.kt
│   │   └── FestivalSubscriptionManager.kt
│   └── repository/
│       └── EventRepository.kt     # 统一数据访问层
│
├── ui/                            # UI层
│   ├── adapters/                  # 适配器
│   │   └── LocationSearchAdapter.kt
│   ├── dialogs/                   # 对话框
│   │   └── EventEditDialogHelper.kt
│   └── managers/                  # UI管理器
│       ├── HolidayManager.kt
│       ├── WeatherManager.kt
│       └── FortuneManager.kt
│
├── utils/                         # 工具类
│   ├── AlarmReceiver.kt           # 提醒接收器
│   ├── EventConverter.kt          # 数据转换器
│   └── PreferenceManager.kt       # 配置管理器
│
└── MainActivity.kt                # 主界面
```

---

## 2.6 设计原则

### 单一职责原则
- 每个类/模块只负责一个功能
- Manager负责业务逻辑，Dao负责数据访问，Adapter负责UI适配

### 开放封闭原则
- 对扩展开放，对修改封闭
- 通过接口抽象实现扩展性

### 依赖倒置原则
- 高层模块不依赖低层模块，都依赖抽象
- Repository依赖Dao接口，不依赖具体实现

### 接口隔离原则
- 客户端不应依赖它不需要的接口
- Service接口按功能拆分，避免臃肿接口

---

## 2.7 数据模型设计

### Event（日程）
```kotlin
data class Event(
    val id: Long = 0,
    val title: String,
    val description: String = "",
    val dateTime: Long,              // Unix时间戳
    val reminderMinutes: Int = 0,    // 提前提醒分钟数
    val subscriptionId: Long? = null, // 订阅ID（如果是订阅的）
    val locationName: String = "",
    val latitude: Double = 0.0,
    val longitude: Double = 0.0,
    val createdAt: Long = System.currentTimeMillis()
)
```

### Subscription（订阅）
```kotlin
data class Subscription(
    val id: Long = 0,
    val name: String,
    val urlSlug: String,
    val isEnabled: Boolean = true,
    val eventCount: Int = 0
)
```

---

## 2.8 模块间通信

### 数据传递
- **Intent**：Activity之间传递数据
- **回调函数**：Adapter、Dialog等组件使用回调
- **LiveData/Flow**：响应式数据流（可选，当前未使用）

### 事件处理
- **观察者模式**：使用回调函数处理事件
- **广播**：提醒功能使用BroadcastReceiver

### 生命周期管理
- **LifecycleScope**：使用Kotlin Coroutines的LifecycleScope
- **ViewModel**：可选，当前未使用

