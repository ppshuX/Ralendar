# ③ 软件架构图

## 3.1 系统整体架构图

```plantuml
@startuml 系统整体架构图

!define RECTANGLE class

package "UI层 (Presentation Layer)" {
    [MainActivity] as MainActivity
    [SubscriptionsActivity] as SubscriptionsActivity
    [FestivalDetailActivity] as FestivalDetailActivity
    [MapPickerActivity] as MapPickerActivity
    [EventAdapter] as EventAdapter
    [TimeSlotAdapter] as TimeSlotAdapter
}

package "业务逻辑层 (Business Logic Layer)" {
    [ReminderManager] as ReminderManager
    [SubscriptionManager] as SubscriptionManager
    [FestivalSubscriptionManager] as FestivalSubscriptionManager
    [HolidayManager] as HolidayManager
    [WeatherManager] as WeatherManager
    [FortuneManager] as FortuneManager
    [EventRepository] as EventRepository
    [AIAssistant] as AIAssistant
}

package "数据层 (Data Layer)" {
    [Room Database] as RoomDB
    [EventDao] as EventDao
    [SubscriptionDao] as SubscriptionDao
    [SharedPreferences] as SP
    [RetrofitClient] as RetrofitClient
    [CalendarApi] as CalendarApi
}

package "外部服务" {
    [Backend API] as BackendAPI
    [AlarmManager] as AlarmManager
    [Notification] as Notification
    [百度地图SDK] as BaiduMap
}

MainActivity --> EventRepository
MainActivity --> ReminderManager
MainActivity --> HolidayManager
MainActivity --> WeatherManager
MainActivity --> FortuneManager

SubscriptionsActivity --> SubscriptionManager
SubscriptionsActivity --> FestivalSubscriptionManager

FestivalDetailActivity --> AIAssistant
FestivalDetailActivity --> CalendarApi

MapPickerActivity --> BaiduMap

EventRepository --> EventDao
EventRepository --> CalendarApi
EventRepository --> RoomDB

SubscriptionManager --> SubscriptionDao
SubscriptionManager --> CalendarApi

FestivalSubscriptionManager --> SP

HolidayManager --> CalendarApi
HolidayManager --> SP

ReminderManager --> AlarmManager
AlarmManager --> Notification

CalendarApi --> RetrofitClient
RetrofitClient --> BackendAPI

@enduml
```

---

## 3.2 数据流架构图

```plantuml
@startuml 数据流架构图

actor 用户
participant "UI层" as UI
participant "Repository" as Repo
participant "Database/API" as Data
participant "Manager" as Mgr

== 日程管理流程 ==

用户 -> UI: 操作（添加/编辑/删除日程）
UI -> Repo: 调用数据操作
alt 本地模式
    Repo -> Data: Room数据库操作
else 云端模式
    Repo -> Data: Retrofit API调用
end
Data --> Repo: 返回结果
Repo --> UI: 更新数据
UI --> 用户: 刷新界面

== 提醒功能流程 ==

用户 -> UI: 设置提醒
UI -> Mgr: ReminderManager
Mgr -> Data: AlarmManager设置闹钟
Data --> Mgr: 确认设置
Mgr --> UI: 返回结果

== 订阅功能流程 ==

用户 -> UI: 订阅日历
UI -> Mgr: SubscriptionManager
Mgr -> Data: 调用API获取日历事件
Data --> Mgr: 返回事件列表
Mgr -> Data: 保存到数据库
Mgr --> UI: 更新日历显示
UI --> 用户: 显示订阅的日程

@enduml
```

---

## 3.3 模块依赖关系图

```plantuml
@startuml 模块依赖关系图

package "核心模块" {
    [MainActivity] as Main
    [EventRepository] as Repo
    [EventDao] as Dao
    [Event] as Event
}

package "功能模块" {
    [ReminderManager] as Reminder
    [SubscriptionManager] as Sub
    [HolidayManager] as Holiday
    [WeatherManager] as Weather
    [FortuneManager] as Fortune
    [FestivalSubscriptionManager] as FestivalSub
}

package "网络模块" {
    [RetrofitClient] as Retrofit
    [CalendarApi] as API
    [EventService] as EventService
    [HolidayService] as HolidayService
    [AIService] as AIService
}

package "数据存储" {
    [Room Database] as Room
    [SharedPreferences] as SP
}

Main --> Repo
Main --> Reminder
Main --> Holiday
Main --> Weather
Main --> Fortune

Repo --> Dao
Repo --> API

Sub --> API
Sub --> Dao

Holiday --> API
Holiday --> FestivalSub

Reminder --> Room

Dao --> Room
Dao --> Event

FestivalSub --> SP

API --> Retrofit
API --> EventService
API --> HolidayService
API --> AIService

Retrofit --> Room

@enduml
```

---

## 3.4 UI层架构图

```plantuml
@startuml UI层架构图

package "Activity" {
    [MainActivity] as Main
    [SubscriptionsActivity] as Sub
    [FestivalDetailActivity] as Festival
    [MapPickerActivity] as Map
}

package "Adapter" {
    [EventAdapter] as EventAdapter
    [TimeSlotAdapter] as TimeSlotAdapter
    [SubscriptionAdapter] as SubAdapter
    [FestivalSubscriptionAdapter] as FestivalAdapter
}

package "Dialog" {
    [EventEditDialogHelper] as Dialog
}

package "View" {
    [CalendarView] as CalendarView
    [WeekCalendarView] as WeekView
    [RecyclerView] as RecyclerView
}

Main --> CalendarView
Main --> WeekView
Main --> RecyclerView
Main --> EventAdapter
Main --> TimeSlotAdapter
Main --> Dialog

Sub --> SubAdapter
Sub --> FestivalAdapter

Festival --> RecyclerView

Map --> RecyclerView

EventAdapter --> Main
TimeSlotAdapter --> Main
SubAdapter --> Sub
FestivalAdapter --> Sub

Dialog --> Main

@enduml
```

---

## 3.5 数据层架构图

```plantuml
@startuml 数据层架构图

package "数据模型" {
    [Event] as Event
    [Subscription] as Subscription
}

package "数据访问" {
    [EventDao] as EventDao
    [SubscriptionDao] as SubscriptionDao
}

package "数据存储" {
    [Room Database] as Room
    [SharedPreferences] as SP
}

package "数据转换" {
    [EventConverter] as Converter
    [EventRepository] as Repository
}

package "网络层" {
    [CalendarApi] as API
    [RetrofitClient] as Retrofit
}

EventDao --> Room
SubscriptionDao --> Room

EventDao --> Event
SubscriptionDao --> Subscription

Repository --> EventDao
Repository --> API
Repository --> Converter

Converter --> Event

API --> Retrofit

@enduml
```

---

## 3.6 业务逻辑层架构图

```plantuml
@startuml 业务逻辑层架构图

package "管理器" {
    [ReminderManager] as Reminder
    [SubscriptionManager] as Sub
    [FestivalSubscriptionManager] as FestivalSub
    [HolidayManager] as Holiday
    [WeatherManager] as Weather
    [FortuneManager] as Fortune
    [AIAssistant] as AI
}

package "数据访问" {
    [EventRepository] as Repo
    [EventDao] as Dao
    [SubscriptionDao] as SubDao
}

package "网络服务" {
    [CalendarApi] as API
}

package "系统服务" {
    [AlarmManager] as Alarm
    [SharedPreferences] as SP
}

Reminder --> Alarm
Reminder --> Dao

Sub --> API
Sub --> SubDao

FestivalSub --> SP

Holiday --> API
Holiday --> SP

Weather --> API

Fortune --> API

AI --> API

Repo --> Dao
Repo --> API

@enduml
```

---

## 3.7 网络层架构图

```plantuml
@startuml 网络层架构图

package "统一接口" {
    [CalendarApi] as API
}

package "服务接口" {
    [EventService] as EventService
    [HolidayService] as HolidayService
    [CalendarService] as CalendarService
    [AIService] as AIService
    [WeatherService] as WeatherService
    [AuthService] as AuthService
}

package "客户端" {
    [RetrofitClient] as Retrofit
}

package "数据模型" {
    [EventModels] as EventModels
    [HolidayModels] as HolidayModels
    [AIModels] as AIModels
}

package "后端服务" {
    [Backend API] as Backend
}

API --> EventService
API --> HolidayService
API --> CalendarService
API --> AIService
API --> WeatherService
API --> AuthService

EventService --> EventModels
HolidayService --> HolidayModels
AIService --> AIModels

EventService --> Retrofit
HolidayService --> Retrofit
CalendarService --> Retrofit
AIService --> Retrofit
WeatherService --> Retrofit
AuthService --> Retrofit

Retrofit --> Backend

@enduml
```

---

## 3.8 视图模式架构图

```plantuml
@startuml 视图模式架构图

package "视图控制器" {
    [MainActivity] as Main
}

package "视图模式" {
    [月视图] as MonthView
    [周视图] as WeekView
    [日视图] as DayView
}

package "日历组件" {
    [CalendarView] as CalendarView
    [WeekCalendarView] as WeekCalendarView
    [RecyclerView] as RecyclerView
}

package "适配器" {
    [EventAdapter] as EventAdapter
    [TimeSlotAdapter] as TimeSlotAdapter
}

package "数据源" {
    [EventRepository] as Repo
}

Main --> MonthView
Main --> WeekView
Main --> DayView

MonthView --> CalendarView
MonthView --> EventAdapter

WeekView --> WeekCalendarView
WeekView --> TimeSlotAdapter

DayView --> RecyclerView
DayView --> TimeSlotAdapter

CalendarView --> Repo
WeekCalendarView --> Repo
RecyclerView --> Repo

EventAdapter --> Repo
TimeSlotAdapter --> Repo

@enduml
```

---

## 使用说明

以上架构图使用 **PlantUML** 格式编写。

### 如何生成图片

1. **在线工具**：
   - 访问 http://www.plantuml.com/plantuml/uml/
   - 复制对应的PlantUML代码
   - 生成图片并下载

2. **VS Code插件**：
   - 安装 "PlantUML" 插件
   - 打开对应的 `.puml` 文件
   - 使用快捷键生成图片

3. **本地工具**：
   - 安装 PlantUML Java 运行时
   - 使用命令行生成图片：
     ```bash
     plantuml ③软件架构图.md
     ```

### 图片替换

生成图片后，可以：
1. 将生成的图片保存到 `adapp/产品报告/` 目录
2. 在文档中引用图片：
   ```markdown
   ![系统整体架构图](系统整体架构图.png)
   ```
3. 或者保留PlantUML代码，支持在线查看

---

## 架构说明

### 3.1 系统整体架构
展示了UI层、业务逻辑层、数据层和外部服务之间的关系。

### 3.2 数据流架构
展示了数据在各个层次之间的流动过程。

### 3.3 模块依赖关系
展示了各个模块之间的依赖关系。

### 3.4 UI层架构
展示了UI组件的层次结构。

### 3.5 数据层架构
展示了数据存储和访问的架构。

### 3.6 业务逻辑层架构
展示了业务逻辑管理器的架构。

### 3.7 网络层架构
展示了网络服务的架构。

### 3.8 视图模式架构
展示了三种视图模式的架构。

